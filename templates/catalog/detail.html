{% extends 'base.html' %}
{% load static crispy_forms_tags qparams %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/uzbek.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- Universal image frame style -->
<style>
  .artar-frame {
    width: 100%;
    height: 450px;               /* bir xil o‚Äòlcham */
    overflow: hidden;
    border-radius: 14px;
    background: #fafafa;
    border: 1px solid #e5e5e5;
  }
  .artar-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;           /* professional ko‚Äòrinish */
  }
</style>

<div class="row g-4">

  <!-- ASAR RASMLARI -->
  <div class="col-lg-7">
    <div class="card shadow-sm uzbek-card">
      <div class="card-header uzbek-card-header py-3">
        <h4 class="mb-0"><i class="bi bi-images me-2"></i>Asar rasmlari</h4>
      </div>

      <div class="card-body p-2 p-sm-3">

        {% if art.images.all %}
        <!-- CAROUSEL -->
        <div id="carouselArt" class="carousel slide uzbek-carousel" data-bs-ride="carousel">
          <div class="carousel-inner">

            {% for img in art.images.all|slice:":3" %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">

              <div class="artar-frame">
                <img src="{{ img.image.url }}" alt="{{ art.title }}" loading="lazy">
              </div>

            </div>
            {% endfor %}
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#carouselArt" data-bs-slide="prev">
            <span class="carousel-control-prev-icon uzbek-carousel-control"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselArt" data-bs-slide="next">
            <span class="carousel-control-next-icon uzbek-carousel-control"></span>
          </button>
        </div>

        {% elif art.first_image_url %}
        <!-- SINGLE IMAGE -->
        <div class="artar-frame">
          <img src="{{ art.first_image_url }}" alt="{{ art.title }}" loading="lazy">
        </div>

        {% else %}
        <!-- NO IMAGE -->
        <div class="placeholder-bg rounded uzbek-placeholder-large text-center py-5">
          <i class="bi bi-image display-1 mb-3"></i>
          <div>ARTAR</div>
          <small class="text-muted">Rasm mavjud emas</small>
        </div>
        {% endif %}

      </div>
    </div>
  </div>

  <!-- ASAR MA'LUMOTLARI -->
  <div class="col-lg-5">
    <div class="card shadow-sm uzbek-card">
      <div class="card-header uzbek-card-header py-3 d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>Asar ma'lumotlari</h4>

        {% if is_owner %}
        <div>
          <a href="{% url 'catalog:update' art.slug %}" class="btn btn-sm btn-warning me-1">
            <i class="bi bi-pencil-square"></i>
          </a>
          <a href="{% url 'catalog:delete' art.slug %}" class="btn btn-sm btn-danger">
            <i class="bi bi-trash"></i>
          </a>
        </div>
        {% endif %}
      </div>

      <div class="card-body">
        <h2 class="h4 mb-3 uzbek-title">{{ art.title }}</h2>

        <div class="uzbek-info-list">
          <div class="uzbek-info-item">
            <i class="bi bi-currency-dollar uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Narx:</span>
              <strong class="uzbek-price">{{ art.price }} so'm</strong>
            </div>
          </div>

          <div class="uzbek-info-item">
            <i class="bi bi-telephone uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Aloqa:</span>
              {% if art.contact %}
                <a href="{{ art.contact|phone_href }}" style="text-decoration:none">{{ art.contact }}</a>
              {% else %}‚Äî{% endif %}
            </div>
          </div>

          {% if art.telegram %}
          <div class="uzbek-info-item">
            <i class="bi bi-telegram uzbek-info-icon text-primary"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Telegram:</span>
              <a href="https://t.me/{{ art.telegram|cut:'@' }}" target="_blank" class="telegram-badge-link">
                <span class="telegram-badge">
                  <i class="bi bi-telegram"></i> @{{ art.telegram|cut:'@' }}
                </span>
              </a>
            </div>
          </div>
          {% endif %}

          {% if art.author %}
          <div class="uzbek-info-item">
            <i class="bi bi-person uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">E'lon egasi:</span>
              <strong>{{ art.author.get_full_name|default:art.author.username }}</strong>
            </div>
          </div>
          {% endif %}

          {% if art.category %}
          <div class="uzbek-info-item">
            <i class="bi bi-tag uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Kategoriya:</span>
              <span class="badge bg-primary">{{ art.category }}</span>
            </div>
          </div>
          {% endif %}

          <div class="uzbek-info-item">
            <i class="bi bi-star uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">O'rtacha reyting:</span>
              <span class="uzbek-rating">‚≠ê {{ avg_rating|floatformat:1 }}</span>
            </div>
          </div>

          <div class="uzbek-info-item">
            <i class="bi bi-eye uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Ko‚Äòrishlar:</span>
              <span class="uzbek-views">üëÅÔ∏è {{ views_count }}</span>
            </div>
          </div>
        </div>

        {% if art.description %}
        <div class="uzbek-description mt-4 p-3 rounded">
          <h6><i class="bi bi-card-text me-2"></i>Tavsif</h6>
          <p class="mb-0 uzbek-text">{{ art.description|linebreaks }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ‚≠ê Reyting -->
<div class="card shadow-sm uzbek-card mt-4">
  <div class="card-header uzbek-card-header">
    <h5 class="mb-0"><i class="bi bi-star-half me-2"></i>Reyting berish</h5>
  </div>
  <div class="card-body">
    {% if user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
        {{ rating_form.value|as_crispy_field }}
        <button type="submit" name="rating_submit" class="btn btn-primary mt-2">
          ‚≠ê Reytingni saqlash
        </button>
      </form>
    {% else %}
      <p class="text-muted">Reyting berish uchun <a href="{% url 'login' %}">login</a> qiling.</p>
    {% endif %}
  </div>
</div>

<!-- üí¨ Izoh -->
<div class="card shadow-sm uzbek-card mt-4">
  <div class="card-header uzbek-card-header">
    <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Izoh qoldirish</h5>
  </div>
  <div class="card-body">
    {% if user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
        {{ comment_form.text|as_crispy_field }}
        <button type="submit" name="comment_submit" class="btn btn-primary mt-2">
          üí¨ Izohni yuborish
        </button>
      </form>
    {% else %}
      <p class="text-muted">Izoh yozish uchun <a href="{% url 'login' %}">login</a> qiling.</p>
    {% endif %}
  </div>
</div>

<!-- Izohlar -->
<div class="card shadow-sm uzbek-card mt-4">
  <div class="card-header uzbek-card-header">
    <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Izohlar</h5>
  </div>
  <div class="card-body">

    {% for comment in comments_page %}
      <div class="mb-3 p-2 border rounded">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted d-block">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
          </div>

          {% if user.is_authenticated and comment.user == user %}
          <a href="{% url 'catalog:comment_delete' comment.id %}" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-trash"></i>
          </a>
          {% endif %}
        </div>

        <p class="mb-0 mt-1">{{ comment.text }}</p>
      </div>
    {% empty %}
      <p class="text-muted">Hozircha izohlar yo‚Äòq.</p>
    {% endfor %}

    <div class="mt-3">
      {% if comments_page.has_previous %}
        <a href="?cpage={{ comments_page.previous_page_number }}" class="btn btn-sm btn-outline-secondary">Oldingi</a>
      {% endif %}
      {% if comments_page.has_next %}
        <a href="?cpage={{ comments_page.next_page_number }}" class="btn btn-sm btn-outline-secondary">Keyingi</a>
      {% endif %}
    </div>

  </div>
</div>

<script defer src="{% static 'js/uzbek-autoclasses.js' %}"></script>
<script defer src="{% static 'js/uzbek-stars.js' %}"></script>
{% endblock %}
