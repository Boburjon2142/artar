{% extends 'base.html' %}
{% load static crispy_forms_tags qparams humanize %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/uzbek.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- Universal image frame style -->
<style>
  .artar-frame {
    width: 100%;
    height: 450px;               /* bir xil o‚Äòlcham */
    overflow: hidden;
    border-radius: 14px;
    background: #fafafa;
    border: 1px solid #e5e5e5;
    display: grid;
    place-items: center;
  }
  .artar-frame img {
    width: 100%;
    height: 100%;
    object-fit: contain;         /* rasm qirqilmaydi, to‚Äòliq ko‚Äòrinadi */
    background: #fafafa;
    padding: 8px;
  }
</style>

<div class="row g-4">

  <!-- ASAR RASMLARI -->
  <div class="col-lg-7">
    <div class="card shadow-sm uzbek-card">
      <div class="card-header uzbek-card-header py-3">
        <h4 class="mb-0"><i class="bi bi-images me-2"></i>Asar rasmlari</h4>
      </div>

      <div class="card-body p-2 p-sm-3">

        {% if art.images.all %}
        <!-- CAROUSEL -->
        <div id="carouselArt" class="carousel slide uzbek-carousel" data-bs-ride="carousel">
          <div class="carousel-inner">

            {% for img in art.images.all|slice:":3" %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">

              <div class="artar-frame">
                <img src="{{ img.image.url }}" alt="{{ art.title }}" loading="lazy">
              </div>

            </div>
            {% endfor %}
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#carouselArt" data-bs-slide="prev">
            <span class="carousel-control-prev-icon uzbek-carousel-control"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselArt" data-bs-slide="next">
            <span class="carousel-control-next-icon uzbek-carousel-control"></span>
          </button>
        </div>

        {% elif art.first_image_url %}
        <!-- SINGLE IMAGE -->
        <div class="artar-frame">
          <img src="{{ art.first_image_url }}" alt="{{ art.title }}" loading="lazy">
        </div>

        {% else %}
        <!-- NO IMAGE -->
        <div class="placeholder-bg rounded uzbek-placeholder-large text-center py-5">
          <i class="bi bi-image display-1 mb-3"></i>
          <div>ARTAR</div>
          <small class="text-muted">Rasm mavjud emas</small>
        </div>
        {% endif %}

      </div>
    </div>
  </div>

  <!-- ASAR MA'LUMOTLARI -->
  <div class="col-lg-5">
    <div class="card shadow-sm uzbek-card">
      <div class="card-header uzbek-card-header py-3 d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>Asar ma'lumotlari</h4>

        {% if is_owner %}
        <div>
          <a href="{% url 'catalog:update' art.slug %}" class="btn btn-sm btn-warning me-1">
            <i class="bi bi-pencil-square"></i>
          </a>
          <a href="{% url 'catalog:delete' art.slug %}" class="btn btn-sm btn-danger">
            <i class="bi bi-trash"></i>
          </a>
        </div>
        {% endif %}
      </div>

      <div class="card-body">
        <h2 class="h4 mb-3 uzbek-title">{{ art.title }}</h2>

        <div class="uzbek-info-list">
          <div class="uzbek-info-item">
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Narx:</span>
              <strong class="uzbek-price">{{ art.price|floatformat:0|intcomma }} so'm</strong>
            </div>
          </div>

          <div class="uzbek-info-item">
            <i class="bi bi-bag-check uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Buyurtma:</span>
              {% if user.is_authenticated %}
                <form method="post" class="d-inline-block">
                  {% csrf_token %}
                  <input type="hidden" name="order_submit" value="1">
                  <button class="btn btn-success btn-sm">Buyurtma berish</button>
                </form>
              {% else %}
                <small class="text-muted">Buyurtma berish uchun <a href="{% url 'login' %}">login</a> qiling.</small>
              {% endif %}
            </div>
          </div>

          <div class="uzbek-info-item">
            <i class="bi bi-aspect-ratio uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">O'lchami:</span>
              <span class="badge bg-secondary">{{ art.dimensions|default:"‚Äî" }}</span>
            </div>
          </div>

          <div class="uzbek-info-item">
            <i class="bi bi-star uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">O'rtacha reyting:</span>
              <span class="uzbek-rating">‚≠ê {{ avg_rating|floatformat:1 }}</span>
            </div>
          </div>

          {% if user.is_authenticated %}
          <div class="mt-2">
            <form method="post" class="rating-inline-form">
              {% csrf_token %}
              <div class="d-flex align-items-center flex-wrap gap-3">
                <strong class="me-2 mb-1">Baholang:</strong>
                <div class="star-rating mb-1">
                  {% for star in star_range %}
                    <input type="radio" name="value" id="star{{ star }}" value="{{ star }}" {% if user_rating == star %}checked{% endif %}>
                    <label for="star{{ star }}" title="{{ star }} yulduz">&#9733;</label>
                  {% endfor %}
                </div>
                <button type="submit" name="rating_submit" class="btn btn-sm btn-primary">
                  ‚≠ê Saqlash
                </button>
              </div>
            </form>
          </div>
          {% else %}
          <div class="mt-2 text-muted small">
            Reyting berish uchun <a href="{% url 'login' %}">login</a> qiling.
          </div>
          {% endif %}

          <div class="uzbek-info-item">
            <i class="bi bi-eye uzbek-info-icon"></i>
            <div class="uzbek-info-content">
              <span class="uzbek-info-label">Ko‚Äòrishlar:</span>
              <span class="uzbek-views">üëÅÔ∏è {{ views_count }}</span>
            </div>
          </div>
        </div>

        {% if art.description %}
        <div class="uzbek-description mt-4 p-3 rounded">
          <h6><i class="bi bi-card-text me-2"></i>Tavsif</h6>
          <p class="mb-0 uzbek-text">{{ art.description|linebreaks }}</p>
        </div>
        {% endif %}

        {% if ai_suggestions %}
        <div class="uzbek-description mt-4 p-3 rounded bg-light">
          <h6 class="d-flex align-items-center mb-2">
            <i class="bi bi-magic me-2"></i> AI content insights
          </h6>
          {% if ai_suggestions.title %}<div><strong>Title:</strong> {{ ai_suggestions.title }}</div>{% endif %}
          {% if ai_suggestions.description %}<div><strong>Description:</strong> {{ ai_suggestions.description }}</div>{% endif %}
          {% if ai_suggestions.style %}<div><strong>Style:</strong> {{ ai_suggestions.style }}</div>{% endif %}
          {% if ai_suggestions.category %}<div><strong>Category:</strong> {{ ai_suggestions.category }}</div>{% endif %}
          {% if ai_suggestions.tags %}<div><strong>Tags:</strong> {{ ai_suggestions.tags|join:", " }}</div>{% endif %}
          {% if ai_suggestions.hashtags %}<div><strong>Hashtags:</strong> #{{ ai_suggestions.hashtags|join:" #"}} </div>{% endif %}
          {% if ai_suggestions.summary %}<div class="mt-2"><strong>Summary:</strong> {{ ai_suggestions.summary }}</div>{% endif %}
          <div class="small text-muted mt-2">Language: {{ request.GET.lang|default:request.LANGUAGE_CODE|default:"en" }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- üí¨ Izoh -->
<div class="card shadow-sm uzbek-card mt-4">
  <div class="card-header uzbek-card-header">
    <h5 class="mb-0"><i class="bi bi-chat-text me-2"></i>Izoh qoldirish</h5>
  </div>
  <div class="card-body">
    {% if user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
        {{ comment_form.text|as_crispy_field }}
        <button type="submit" name="comment_submit" class="btn btn-primary mt-2">
          üí¨ Izohni yuborish
        </button>
      </form>
    {% else %}
      <p class="text-muted">Izoh yozish uchun <a href="{% url 'login' %}">login</a> qiling.</p>
    {% endif %}
  </div>
</div>

<!-- Izohlar -->
<div class="card shadow-sm uzbek-card mt-4">
  <div class="card-header uzbek-card-header">
    <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Izohlar</h5>
  </div>
  <div class="card-body">

    {% for comment in comments_page %}
      <div class="mb-3 p-2 border rounded">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted d-block">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
          </div>

          {% if user.is_authenticated and comment.user == user %}
          <a href="{% url 'catalog:comment_delete' comment.id %}" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-trash"></i>
          </a>
          {% endif %}
        </div>

        <p class="mb-0 mt-1">{{ comment.text }}</p>
      </div>
    {% empty %}
      <p class="text-muted">Hozircha izohlar yo‚Äòq.</p>
    {% endfor %}

    <div class="mt-3">
      {% if comments_page.has_previous %}
        <a href="?cpage={{ comments_page.previous_page_number }}" class="btn btn-sm btn-outline-secondary">Oldingi</a>
      {% endif %}
      {% if comments_page.has_next %}
        <a href="?cpage={{ comments_page.next_page_number }}" class="btn btn-sm btn-outline-secondary">Keyingi</a>
      {% endif %}
    </div>

  </div>
</div>

<script defer src="{% static 'js/uzbek-autoclasses.js' %}"></script>
<script defer src="{% static 'js/uzbek-stars.js' %}"></script>
<style>
.star-rating {
  display: inline-flex;
  flex-direction: row-reverse;
  gap: 8px;
}
.star-rating input {
  display: none;
}
.star-rating label {
  font-size: 30px;
  color: #d3d3d3;
  cursor: pointer;
  transition: color 0.15s ease;
}
.star-rating label:hover,
.star-rating label:hover ~ label,
.star-rating input:checked ~ label {
  color: #f6c344;
}
</style>
{% endblock %}
